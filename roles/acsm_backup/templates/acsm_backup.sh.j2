#!/bin/bash
###
# prune zip files older than 30 days (+29) from {{ siteFQDN }}
# backup acsm zip files from {{ acsmFQDN }} to {{ siteFQDN }}
# prune zip files older than 7 (+6) days from {{ acsmFQDN }}
# Added by Ansible {{ ansible_date_time.date }} {{ansible_date_time.time}}
###
echo "$(date +%Y%m%d:%H%M%S): Starting."

# prune local files
echo "$(date +%Y%m%d:%H%M%S): remove local .zips older than 30 (+29) days old."

find {{ backup_destination }} -name *.zip -ctime +29 -exec rm -rvf '{}' \;

if [ $? != 0 ]; then
    echo "$(date +%Y%m%d:%H%M%S): local prune failed. Exiting"
    exit 1;
fi

# copy remote
echo "$(date +%Y%m%d:%H%M%S): Pull backups from {{ acsmFQDN }}";

rsync -a  --log-file=/var/log/backup_acsm.log \
    -e 'ssh -i /home/{{ adminuser }}/.ssh/{{ backup_key }}' \
    {{ assettouser }}@{{ acsmFQDN }}:{{ backup_path }}/ \
        {{ backup_destination }}

if [ $? != 0 ]; then
    echo "$(date +%Y%m%d:%H%M%S): rsync failed. Exiting"
    exit 1;
fi

# prune remote
echo "$(date +%Y%m%d:%H%M%S): remove .zips older than 7 (+6) days old on {{ acsmFQDN }}"

ssh -i /home/{{ adminuser }}/.ssh/{{ backup_key }} \
    {{ assettouser }}@{{ acsmFQDN }} "find {{ backup_path }} \
        -name *.zip -ctime +6 -exec rm -rvf '{}' \;"

if [ $? != 0 ]; then
    echo "$(date +%Y%m%d:%H%M%S): prune failed. Exiting"
    exit 1;
fi

# exit
echo "$(date +%Y%m%d:%H%M%S): Exiting"
exit
